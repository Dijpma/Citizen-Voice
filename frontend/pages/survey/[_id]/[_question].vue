<template>
    <NuxtLayout name="default">
        <div class="">
            <qt_text v-if="questions[current_question_index].question_type === 'text'" :question_index="current_question_index" :question="questions[current_question_index]"></qt_text>
            <qt_multiple_choice v-if="questions[current_question_index].question_type === 'select'" :question_index="current_question_index" :question="questions[current_question_index]" ></qt_multiple_choice>
            <qt_select_multiple v-if="questions[current_question_index].question_type === 'select_multiple'" :question_index="current_question_index" :question="questions[current_question_index]" ></qt_select_multiple>
        </div>

        <div class="q-pa-md row items-start q-gutter-md">
            <!-- Map card -->
            <div v-show="(question.map_view != null || question.is_geospatial)" style="min-width: 600px;"
                class="my-card col">
                <div style="height:300px; width:600px">
                    <l-map ref="map" v-model:zoom="map_view.options.zoom" :center="map_view.options.center" :minZoom="1"
                        :maxZoom="18" @click="addCircle">
                        <l-tile-layer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" layer-type="base"
                            name="OpenStreetMap"></l-tile-layer>
                        <l-circle v-for="circle, index in map_view.options.points" :lat-lng="circle"
                            :radius="map_view.options.radius" :color="map_view.options.color"
                            :fillColor="map_view.options.fillColor"></l-circle>
                        <l-circle v-for="circle, index in circles" @click="removeCircle(index)" :lat-lng="circle"
                            :radius="map_view.options.radius" :color="map_view.options.color"
                            :fillColor="map_view.options.fillColor"></l-circle>
                        <l-control position="bottomleft">
                            <v-btn @click="resetMap">
                                Reset
                            </v-btn>
                        </l-control>
                    </l-map>
                </div>
            </div>

            <!-- Answer card-->
<!--            <div class="my-card col">-->
<!--                <v-textarea name="title" v-model="answer_field" type="textarea" label="Give answer here"></v-textarea>-->
<!--            </div>-->
        </div>

        <!-- Navigation -->
        <div class="q-pa-md row">
            <v-btn @click="prevQuestion" color="primary">
                <i class="fa-solid fa-arrow-left"></i>
                <span class="q-pa-sm">Previous Question</span>
            </v-btn>
            <v-space />
            <v-btn @click="nextQuestion" color="primary">
                <i class="fa-solid fa-arrow-right"></i>
                <span class="q-pa-sm">Next Question</span>
            </v-btn>
        </div>

    </NuxtLayout>
</template>


<script setup>

import { ref } from "vue"
import { navigateTo } from "nuxt/app";
// import { useStoreResponse } from '~/stores/response'
// import leaflet from "leaflet"
import "leaflet/dist/leaflet.css";
import { LMap, LTileLayer, LCircle, LControl } from "@vue-leaflet/vue-leaflet";

// const responseStore = useStoreResponse()
const question_url = "/api/questions/"
const mapview_url = "/api/map_views/"

const route = useRoute()
// Fixme: Cleanup these functions
import { useSurveyStore } from "~/stores/survey.js";
import Qt_text from "~/components/respondent_view_question_types/qt_text.vue";
import Qt_multiple_choice from "~/components/respondent_view_question_types/qt_multiple_choice.vue";
import Qt_select_multiple from "~/components/respondent_view_question_types/qt_select_multiple.vue";

const survey_store = useSurveyStore()
// const { data: survey } = await useAsyncData(() => $cmsApi(survey_url + route.params._id));
const { data: questions } = await survey_store.getQuestionsOfSurvey(route.params._id)
let current_question_index = ref(0)

// const survey = await responseStore.getResponse(route.params._id)


// TODO: use an API to get n'th question of the selected survey
let demo_question = 3 // This is a hardcoded value for now
let { data: question } = await useAsyncData(() => $cmsApi(question_url + demo_question));
// TODO: get question.map_view once APIs are configured
const { data: map_view } = await useAsyncData(() => $cmsApi(mapview_url + 1)); // for demo only, I will use 5th

// to set up the map
// const center = ref([47.41322, -1.219482])
// const circleSettings = ref(
//   {circleColor: 'red', radius: 3000}
// )
const circles = ref([]) // this is what user will add
// L.latLng(47.414, -1.22),
// circleClickedAndRemoved is a boolean we use to keep track of whether a circle was just clicked
// if that is the case, we will not call the addCircle function
let circleClickedAndRemoved = false
let resetClicked = false


// to navigate from one question to the previous/next
const prevQuestion = async () => {
  console.log("Prev question")
  current_question_index.value -= 1
  current_question_index.value = Math.max(current_question_index.value, 0)
  console.log(current_question_index.value)
    // TODO: Implement
}
const nextQuestion = async () => {
  console.log("Next question")

  current_question_index.value += 1
  current_question_index.value = Math.min(current_question_index.value, questions.value.length-1)
  console.log(current_question_index.value)
  console.log(questions.value[current_question_index.value].text)
}

// inspired by Roy J's solution on Stack Overflow:
// https://stackoverflow.com/questions/54499070/leaflet-and-vuejs-how-to-add-a-new-marker-onclick-in-the-map
const removeCircle = async (index) => {
    console.log("removeCircle function called")
    circles._value.splice(index, 1)
    circleClickedAndRemoved = true
}
const addCircle = async (event) => {
    if (circleClickedAndRemoved) {
        circleClickedAndRemoved = false
    } else if (resetClicked) {
        resetClicked = false
    } else {
        console.log("addCircle function called")
        circles._value.push(
            [event.latlng.lat, event.latlng.lng]
        )
    }
}
const resetMap = async () => {
    console.log("resetMap function called")
    circles._value.splice(0, circles._value.length)
    // TODO: reset map center and zoom level based on map_view
    resetClicked = true
}

</script>

<style lang="scss">
#map {
    height: 180px;
}
</style>
